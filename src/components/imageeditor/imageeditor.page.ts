import { ModalController } from '@ionic/angular';
import { Component, EventEmitter, Input, OnInit, Output } from '@angular/core';
import ImageEditor from 'tui-image-editor';
import { RecordedFile, DownloadService } from 'src/services/download-service';
import { Filesystem, FilesystemDirectory } from '@capacitor/core';
import { File as nFile } from '@ionic-native/file/ngx';
import { ApiSync } from 'src/providers/api-sync';
import { GuideStepService } from 'src/providers/api/guide-step-service';


interface CustomControls {
  name: string
  icon: string
  subControls?: CustomControls[]
}

@Component({
  selector: 'text-editor',
  templateUrl: './imageeditor.page.html',
  styleUrls: ['./imageeditor.page.scss'],
})
export class ImageEditorComponent implements OnInit {

  @Input() model;

  ImageEditor;
  canvasObject: any[] = [];

  currentControl: CustomControls = { name: null, icon: null };
  currentSubControl: CustomControls = { name: null, icon: null };

  controls: CustomControls[] = [
    {
      name: 'Draw',
      icon: 'create',
      subControls: [
        {
          name: 'Free Hand',
          icon: 'pulse',
        },
        {
          name: 'Line',
          icon: 'remove',
        }
      ]
    }
  ]
  constructor(
    private guideStepService: GuideStepService,
    private modalController: ModalController, private downloadService: DownloadService, private file: nFile, private apiSync: ApiSync,
  ) { }

  ngOnInit() {
    this.ImageEditor = new ImageEditor(document.querySelector('#tui-image-editor'), {
      cssMaxWidth: document.documentElement.clientWidth,
      cssMaxHeight: document.documentElement.clientHeight,
    });

    this.ImageEditor.loadImageFromURL(this.model.getFileImagePath().changingThisBreaksApplicationSecurity, 'Editor Test').then(() => {
      this.ImageEditor.clearUndoStack();
    })

    this.ImageEditor.on('objectAdded', (props) => {
      console.log("objectAdded");
      console.log(props);
    });

    this.ImageEditor.on('mousedown', (event, originPointer) => {
      console.log("mousedown");
      console.log(this.ImageEditor._graphics._objects[0]);
    });

    this.ImageEditor.on('objectActivated', (props) => {
      console.log("objectActivated");
      console.log(props);
    });
  }

  addShape() {
    const sampleCanvasMetaData = `
      {\"version\":\"3.6.0\",\"objects\":[{\"type\":\"path\",\"version\":\"3.6.0\",\"originX\":\"center\",
      \"originY\":\"center\",\"left\":1548.13,\"top\":1213.99,\"width\":1434.29,\"height\":1396.71,\"fill\":null,
      \"stroke\":\"rgba(255,64,64,1)\",\"strokeWidth\":28,\"strokeDashArray\":null,\"strokeLineCap\":\"round\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"round\",\"strokeMiterLimit\":10,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"clipTo\":null,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"transformMatrix\":null,\"skewX\":0,\"skewY\":0,\"path\":[[\"M\",830.9904049079755,545.6407116564418],[\"Q\",831.0184049079755,545.6687116564418,832.2699386503068,569.4478527607363],[\"Q\",833.5214723926381,593.2269938650307,837.2760736196319,627.0184049079755],[\"Q\",841.0306748466259,660.8098159509203,859.8036809815951,793.4723926380368],[\"Q\",878.5766871165645,926.1349693251534,879.8282208588957,954.9202453987731],[\"Q\",881.079754601227,983.7055214723928,888.5889570552148,1065.0552147239264],[\"Q\",896.0981595092026,1146.4049079754602,898.6012269938651,1171.435582822086],[\"Q\",901.1042944785277,1196.4662576687117,908.6134969325153,1260.2944785276075],[\"Q\",916.1226993865031,1324.1226993865032,916.1226993865031,1361.6687116564417],[\"Q\",916.1226993865031,1399.2147239263804,918.6257668711658,1444.2699386503068],[\"Q\",921.1288343558283,1489.3251533742332,923.6319018404909,1518.1104294478528],[\"Q\",926.1349693251534,1546.8957055214726,926.1349693251534,1568.1717791411045],[\"Q\",926.1349693251534,1589.4478527607364,926.1349693251534,1610.7239263803683],[\"Q\",926.1349693251534,1632.0000000000002,926.1349693251534,1650.7730061349694],[\"Q\",926.1349693251534,1669.5460122699387,926.1349693251534,1680.8098159509204],[\"Q\",926.1349693251534,1692.073619631902,926.1349693251534,1705.840490797546],[\"Q\",926.1349693251534,1719.6073619631902,926.1349693251534,1727.1165644171779],[\"Q\",926.1349693251534,1734.6257668711658,926.1349693251534,1740.8834355828221],[\"Q\",926.1349693251534,1747.1411042944787,926.1349693251534,1748.39263803681],[\"Q\",926.1349693251534,1749.6441717791413,927.3865030674847,1753.3987730061351],[\"Q\",928.6380368098161,1757.153374233129,928.6380368098161,1759.6564417177915],[\"Q\",928.6380368098161,1762.159509202454,928.6380368098161,1765.914110429448],[\"Q\",928.6380368098161,1769.668711656442,928.6380368098161,1773.4233128834358],[\"Q\",928.6380368098161,1777.1779141104296,931.1411042944786,1783.435582822086],[\"Q\",933.6441717791412,1789.6932515337426,936.1472392638037,1793.4478527607364],[\"Q\",938.6503067484663,1797.2024539877302,944.9079754601228,1800.957055214724],[\"Q\",951.1656441717793,1804.7116564417179,953.6687116564418,1805.9631901840492],[\"Q\",956.1717791411044,1807.2147239263804,961.1779141104296,1812.2208588957055],[\"Q\",966.1840490797547,1817.2269938650309,967.435582822086,1817.2269938650309],[\"Q\",968.6871165644172,1817.2269938650309,972.4417177914111,1819.7300613496934],[\"Q\",976.196319018405,1822.233128834356,979.950920245399,1824.7361963190185],[\"Q\",983.7055214723928,1827.239263803681,988.7116564417179,1829.7423312883436],[\"Q\",993.717791411043,1832.2453987730062,1007.4846625766872,1834.748466257669],[\"Q\",1021.2515337423314,1837.2515337423315,1037.521472392638,1842.2576687116566],[\"Q\",1053.791411042945,1847.2638036809817,1076.319018404908,1849.7668711656443],[\"Q\",1098.8466257668713,1852.2699386503068,1141.3987730061351,1863.5337423312885],[\"Q\",1183.950920245399,1874.79754601227,1211.4846625766872,1879.8036809815953],[\"Q\",1239.0184049079755,1884.8098159509204,1279.0674846625768,1896.0736196319021],[\"Q\",1319.116564417178,1907.3374233128836,1366.674846625767,1909.8404907975462],[\"Q\",1414.233128834356,1912.3435582822087,1453.030674846626,1912.3435582822087],[\"Q\",1491.8282208588957,1912.3435582822087,1559.4110429447853,1912.3435582822087],[\"Q\",1626.993865030675,1912.3435582822087,1668.2944785276075,1912.3435582822087],[\"Q\",1709.59509202454,1912.3435582822087,1769.6687116564417,1907.3374233128836],[\"Q\",1829.7423312883436,1902.3312883435585,1868.5398773006136,1899.8282208588957],[\"Q\",1907.3374233128836,1897.3251533742332,1953.6441717791413,1888.5644171779143],[\"Q\",1999.950920245399,1879.8036809815953,2061.276073619632,1858.5276073619634],[\"Q\",2122.601226993865,1837.2515337423315,2137.619631901841,1827.2392638036813],[\"Q\",2152.638036809816,1817.2269938650309,2167.6564417177915,1807.2147239263804],[\"Q\",2182.6748466257673,1797.2024539877302,2188.932515337424,1792.1963190184051],[\"Q\",2195.19018404908,1787.1901840490798,2198.944785276074,1782.1840490797547],[\"Q\",2202.6993865030677,1777.1779141104296,2205.20245398773,1775.9263803680983],[\"Q\",2207.705521472393,1774.674846625767,2212.711656441718,1772.1717791411045],[\"Q\",2217.717791411043,1769.668711656442,2225.2269938650306,1768.4171779141107],[\"Q\",2232.7361963190187,1767.1656441717794,2244,1764.6625766871166],[\"Q\",2255.2638036809817,1762.159509202454,2259.0184049079753,1760.9079754601228],[\"Q\",2262.7730061349694,1759.6564417177915,2264.0245398773004,1758.4049079754602],[\"Q\",2265.276073619632,1757.153374233129,2265.276073619632,1755.9018404907977],[\"Q\",2265.276073619632,1754.6503067484664,2265.276073619632,1737.1288343558283],[\"Q\",2265.276073619632,1719.6073619631902,2265.276073619632,1703.3374233128834],[\"Q\",2265.276073619632,1687.0674846625768,2265.276073619632,1648.2699386503068],[\"Q\",2265.276073619632,1609.472392638037,2261.5214723926383,1579.435582822086],[\"Q\",2257.7668711656443,1549.3987730061351,2251.509202453988,1486.8220858895706],[\"Q\",2245.2515337423315,1424.2453987730062,2241.496932515338,1385.4478527607362],[\"Q\",2237.742331288344,1346.6503067484664,2228.9815950920247,1285.3251533742332],[\"Q\",2220.2208588957055,1224,2215.2147239263804,1186.4539877300613],[\"Q\",2210.2085889570553,1148.9079754601228,2205.20245398773,1110.1104294478528],[\"Q\",2200.196319018405,1071.312883435583,2193.938650306749,1028.7607361963192],[\"Q\",2187.6809815950924,986.2085889570553,2182.674846625767,942.4049079754602],[\"Q\",2177.6687116564417,898.6012269938651,2176.4171779141107,879.8282208588957],[\"Q\",2175.165644171779,861.0552147239265,2172.6625766871166,846.0368098159511],[\"Q\",2170.159509202454,831.0184049079755,2170.159509202454,819.7546012269939],[\"Q\",2170.159509202454,808.4907975460123,2170.159509202454,794.7239263803681],[\"Q\",2170.159509202454,780.9570552147239,2168.9079754601225,764.6871165644172],[\"Q\",2167.6564417177915,748.4171779141105,2166.4049079754604,740.9079754601228],[\"Q\",2165.153374233129,733.398773006135,2163.9018404907974,727.1411042944785],[\"Q\",2162.6503067484664,720.8834355828221,2162.6503067484664,714.6257668711658],[\"Q\",2162.6503067484664,708.3680981595093,2161.3987730061353,698.3558282208589],[\"Q\",2160.147239263804,688.3435582822086,2158.8957055214723,679.5828220858896],[\"Q\",2157.6441717791413,670.8220858895706,2155.1411042944787,660.8098159509203],[\"Q\",2152.638036809816,650.79754601227,2151.386503067485,644.5398773006136],[\"Q\",2150.1349693251536,638.2822085889571,2147.631901840491,629.5214723926381],[\"Q\",2145.1288343558285,620.760736196319,2143.877300613497,614.5030674846626],[\"Q\",2142.625766871166,608.2453987730062,2138.871165644172,598.2331288343559],[\"Q\",2135.116564417178,588.2208588957055,2132.6134969325153,581.9631901840492],[\"Q\",2130.1104294478528,575.7055214723927,2125.1042944785277,566.9447852760736],[\"Q\",2120.0981595092026,558.1840490797547,2116.3435582822085,553.1779141104296],[\"Q\",2112.588957055215,548.1717791411044,2106.3312883435583,540.6625766871166],[\"Q\",2100.073619631902,533.1533742331288,2096.319018404908,529.398773006135],[\"Q\",2092.5644171779145,525.6441717791412,2086.306748466258,520.638036809816],[\"Q\",2080.0490797546013,515.6319018404909,2076.2944785276077,515.6319018404909],[\"Q\",2072.5398773006136,515.6319018404909,2066.2822085889575,515.6319018404909],[\"Q\",2060.024539877301,515.6319018404909,2046.2576687116566,515.6319018404909],[\"Q\",2032.4907975460123,515.6319018404909,2008.7116564417179,515.6319018404909],[\"Q\",1984.9325153374234,515.6319018404909,1963.6564417177915,515.6319018404909],[\"Q\",1942.3803680981596,515.6319018404909,1893.5705521472394,516.8834355828221],[\"Q\",1844.7607361963192,518.1349693251534,1809.717791411043,519.3865030674847],[\"Q\",1774.674846625767,520.638036809816,1720.8588957055217,524.3926380368098],[\"Q\",1667.0429447852762,528.1472392638037,1635.754601226994,530.6503067484663],[\"Q\",1604.4662576687117,533.1533742331288,1559.4110429447853,535.6564417177915],[\"Q\",1514.355828220859,538.159509202454,1488.073619631902,538.159509202454],[\"Q\",1461.791411042945,538.159509202454,1417.9877300613498,538.159509202454],[\"Q\",1374.1840490797547,538.159509202454,1345.3987730061351,538.159509202454],[\"Q\",1316.6134969325155,538.159509202454,1281.5705521472394,538.159509202454],[\"Q\",1246.5276073619632,538.159509202454,1230.2576687116566,538.159509202454],[\"Q\",1213.9877300613498,538.159509202454,1191.4601226993866,539.4110429447853],[\"Q\",1168.9325153374234,540.6625766871166,1153.914110429448,540.6625766871166],[\"Q\",1138.8957055214726,540.6625766871166,1122.6257668711658,540.6625766871166],[\"Q\",1106.355828220859,540.6625766871166,1098.8466257668713,540.6625766871166],[\"Q\",1091.3374233128836,540.6625766871166,1078.8220858895706,540.6625766871166],[\"Q\",1066.3067484662577,540.6625766871166,1058.79754601227,540.6625766871166],[\"Q\",1051.2883435582823,540.6625766871166,1043.7791411042945,540.6625766871166],[\"Q\",1036.2699386503068,540.6625766871166,1030.0122699386504,540.6625766871166],[\"Q\",1023.7546012269939,540.6625766871166,1012.4907975460123,541.9141104294479],[\"Q\",1001.2269938650307,543.1656441717791,992.4662576687117,544.4171779141104],[\"Q\",983.7055214723928,545.6687116564418,981.2024539877302,546.9202453987731],[\"Q\",978.6993865030676,548.1717791411044,973.6932515337423,549.4233128834356],[\"Q\",968.6871165644172,550.6748466257669,964.9325153374234,553.1779141104295],
      [\"Q\",961.1779141104296,555.680981595092,956.1717791411045,555.680981595092],[\"Q\",951.1656441717793,555.680981595092,948.6625766871166,558.1840490797547],[\"Q\",946.159509202454,560.6871165644172,939.9018404907977,560.6871165644172],[\"Q\",933.6441717791412,560.6871165644172,928.638036809816,561.9386503067485],[\"Q\",923.6319018404909,563.1901840490798,917.3742331288345,563.1901840490798],[\"Q\",911.116564417178,563.1901840490798,907.361963190184,563.1901840490798],[\"Q\",903.6073619631902,563.1901840490798,898.6012269938651,563.1901840490798],[\"Q\",893.5950920245399,563.1901840490798,889.8404907975461,563.1901840490798],[\"Q\",886.0858895705522,563.1901840490798,883.5828220858896,563.1901840490798],[\"Q\",881.079754601227,563.1901840490798,879.8282208588957,563.1901840490798],[\"L\",878.5486871165645,563.1901840490798]]},{\"type\":\"rect\",\"version\":\"3.6.0\",\"originX\":\"center\",\"originY\":\"center\",\"left\":1632.84,\"top\":1226.08,\"width\":3101.09,\"height\":2290.17,\"fill\":\"\",\"stroke\":\"#ffbb3b\",\"strokeWidth\":97,\"strokeDashArray\":null,\"strokeLineCap\":\"butt\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"miter\",\"strokeMiterLimit\":4,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"clipTo\":null,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"transformMatrix\":null,\"skewX\":0,\"skewY\":0,\"rx\":0,\"ry\":0}],\"backgroundImage\":{\"type\":\"image\",\"version\":\"3.6.0\",\"originX\":\"left\",\"originY\":\"top\",\"left\":0,\"top\":0,\"width\":3264,\"height\":2448,\"fill\":\"rgb(0,0,0)\",\"stroke\":null,\"strokeWidth\":0,\"strokeDashArray\":null,\"strokeLineCap\":\"butt\",\"strokeDashOffset\":0,\"strokeLineJoin\":\"miter\",\"strokeMiterLimit\":4,\"scaleX\":1,\"scaleY\":1,\"angle\":0,\"flipX\":false,\"flipY\":false,\"opacity\":1,\"shadow\":null,\"visible\":true,\"clipTo\":null,\"backgroundColor\":\"\",\"fillRule\":\"nonzero\",\"paintFirst\":\"fill\",\"globalCompositeOperation\":\"source-over\",\"transformMatrix\":null,\"skewX\":0,\"skewY\":0,\"crossOrigin\":\"Anonymous\",\"cropX\":0,\"cropY\":0,\"src\":\"http://tw-app-dev.devhost.taktwerk.ch/elfinder/connect?cmd=file&target=fls1_L3VwbG9hZHMvR3VpZGVTdGVwLzIyNy8xNjA1MDAyODYyX3JvdGF0ZWRfaW1hZ2UuanBn&etag=387fdb2c26e770ee10b5ed3c76e14d9a&lastModified=Tue%2C+10+Nov+2020+10%3A07%3A42+GMT\",\"filters\":[]}}`

    var canvasMeta = JSON.parse(sampleCanvasMetaData);
    console.log(canvasMeta)
    canvasMeta.backgroundImage.src = this.model.getFileImagePath().changingThisBreaksApplicationSecurity;
    console.log(canvasMeta)

    var iCanvas = this.ImageEditor._graphics.getCanvas();
    console.log(iCanvas)

    var selectionStyle = this.ImageEditor._graphics.cropSelectionStyle;

    console.log(selectionStyle)
    // this.ImageEditor.loadImageFromURL("https://images.pexels.com/photos/3507116/pexels-photo-3507116.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=750&w=1260", 'Editor Test').then(() => {
    setTimeout(() => {
      iCanvas.lowerCanvasEl.style.border = "double #2d2d2b";

      iCanvas.loadFromJSON(canvasMeta, () => {

        var list = iCanvas.getObjects();

        list.forEach(function (obj) {
          obj.set(selectionStyle);
        });
      });
    }, 200);
    // })

  }

  onControl(control: CustomControls) {
    // stop all modes
    this.ImageEditor.stopDrawingMode();

    //
    this.currentControl.name != control.name ? this.currentControl = control : this.currentControl = { name: null, icon: null };
  }

  onSubControl(control: CustomControls) {
    // stop all modes
    this.ImageEditor.stopDrawingMode();

    // 
    this.currentSubControl.name != control.name ? this.currentSubControl = control : this.currentSubControl = { name: null, icon: null };
    if (this.currentSubControl.name != null) {
      switch (control.name) {
        case ('Free Hand'):
          this.ImageEditor.stopDrawingMode();
          this.ImageEditor.startDrawingMode('FREE_DRAWING', { width: 15, color: 'red' });
          break;
        case ('Line'):
          this.ImageEditor.stopDrawingMode();
          this.ImageEditor.startDrawingMode('LINE_DRAWING', { width: 15, color: 'red' });
          break;
        default:
      }
    }

  }

  closeControl() {
    // stop all modes
    this.ImageEditor.stopDrawingMode();
    this.currentControl = { name: null, icon: null };
    this.currentSubControl = { name: null, icon: null };
  }

  onChange(e) {
    console.log(e);
  }

  async onDone() {
    var dataURL = this.ImageEditor.toDataURL({ format: 'png' });
    var blob = this.base64ToBlob(dataURL);

    const fileName = new Date().getTime() + '.png';
    const recordedFile = new RecordedFile();

    this.downloadService.checkTempDir().then((e) => {
      this.file.writeFile(this.file.dataDirectory + '/_temp', fileName, blob, { replace: true }).then(async (res) => {
        console.log(res)
        recordedFile.uri = await this.downloadService.getResolvedNativeFilePath(res.nativeURL);
        this.model.setFile(recordedFile);

        this.guideStepService.save(this.model).then(async () => {
          this.apiSync.setIsPushAvailableData(true);
          await this.modalController.dismiss();
        }).catch((e) => console.log(e))

      }).catch((e) => console.log(e))
    })
  }

  base64ToBlob(data) {
    var rImageType = /data:(image\/.+);base64,/;
    var mimeString = '';
    var raw, uInt8Array, i, rawLength;

    raw = data.replace(rImageType, (header, imageType) => {
      mimeString = imageType;
      return '';
    });

    raw = atob(raw);
    rawLength = raw.length;
    uInt8Array = new Uint8Array(rawLength);

    for (i = 0; i < rawLength; i += 1) {
      uInt8Array[i] = raw.charCodeAt(i);
    }

    return new Blob([uInt8Array], { type: mimeString });
  }

  onReady(e) {

  }
}
